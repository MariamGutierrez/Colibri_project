{% extends 'reportes/base.html' %}

{% block title %}Detalle del Avistamiento{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-sA+e2r5E8pLR1nCgfMNsz1U8c9+ScVX3QuP0FK5n/kM=" crossorigin=""/>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ avistamiento.nombre }}</h1>

    <p><strong>Descripción:</strong> {{ avistamiento.descripcion }}</p>
    <p><strong>Fecha:</strong> {{ avistamiento.fecha_creacion }}</p>
    <p><strong>Ubicación (texto):</strong> {{ avistamiento.ubicacion }}</p>
    <p><strong>Tipo de Especie:</strong> {{ avistamiento.tipo_especie }}</p>
    <p>
        <strong>Estado del Reporte:</strong>
        {% if avistamiento.publicado %}
            <span class="badge bg-success">✅ Publicado</span>
        {% else %}
            <span class="badge bg-warning text-dark">⏳ Pendiente</span>
        {% endif %}
    </p>

    {% if avistamiento.imagen %}
        <div class="mt-3">
            <p><strong>Imagen:</strong></p>
            <img src="{{ avistamiento.imagen.url }}" class="img-fluid rounded" alt="Imagen del avistamiento">
        </div>
    {% endif %}

    {% if avistamiento.latitud and avistamiento.longitud %}
<script>
    const lat = parseFloat('{{ avistamiento.latitud }}');
    const lng = parseFloat('{{ avistamiento.longitud }}');

    if (!isNaN(lat) && !isNaN(lng)) {
        var map = L.map('map').setView([lat, lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        L.marker([lat, lng]).addTo(map)
            .bindPopup("Ubicación del avistamiento")
            .openPopup();
    }
</script>
{% endif %}

    <a href="{% url 'ver_cuenta' %}" class="btn btn-secondary mt-4">Volver a mi cuenta</a>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-pHQqjLIF3b6F/6LurhFjzfaFyz7p3jN6s8U1p3wtG7g=" crossorigin=""></script>

{% if avistamiento.latitud and avistamiento.longitud %}
<script>
    var map = L.map('map').setView([parseFloat('{{ avistamiento.latitud }}'), parseFloat('{{ avistamiento.longitud }}')], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    L.marker([parseFloat('{{ avistamiento.latitud }}'), parseFloat('{{ avistamiento.longitud }}')]).addTo(map)
        .bindPopup("Ubicación del avistamiento")
        .openPopup();
</script>
{% endif %}

{% if rechazo %}
    <div class="alert alert-danger mt-4" role="alert">
        ❌ <strong>Este avistamiento fue rechazado.</strong><br>
        <strong>Motivo:</strong> {{ rechazo.mensaje }}<br>
        <small>Se eliminará en {{ rechazo.dias_restantes }} días hábiles.</small>
    </div>
{% endif %}

{% endblock %}
