<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Avistamientos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
    </style>
</head>
<body>
    {% extends "avistamientos/base.html" %}
    {% block content %}
    <div class="container mt-4">
        <h1 class="text-center">Avistamientos</h1>
        <div class="filters mb-4">
            <form method="GET" action="">
                <label for="tipo_especie">Tipo de Especie:</label>
                <select id="tipo_especie" name="tipo_especie" class="form-select d-inline-block w-auto">
                    <option value="">Todos</option>
                    <option value="fauna" {% if tipo_especie == "fauna" %}selected{% endif %}>Fauna</option>
                    <option value="flora" {% if tipo_especie == "flora" %}selected{% endif %}>Flora</option>
                </select>

                <label for="estado_conservacion">Estado de Conservaci√≥n:</label>
                <select id="estado_conservacion" name="estado_conservacion" class="form-select d-inline-block w-auto">
                    <option value="">Todos</option>
                    <option value="en_peligro" {% if estado_conservacion == "en_peligro" %}selected{% endif %}>En Peligro</option>
                    <option value="invasora" {% if estado_conservacion == "invasora" %}selected{% endif %}>Invasora</option>
                    <option value="comun" {% if estado_conservacion == "comun" %}selected{% endif %}>Com√∫n</option>
                </select>

                <button type="submit" class="btn btn-primary">Filtrar</button>
            </form>
        </div>

        <div class="stats-bar mb-4" style="background-color: #4A6653; color: white; padding: 20px; display: flex; justify-content: space-around;">
            <div class="stat text-center">
                <h3>Total Especies</h3>
                <p id="total-especies" class="fs-4">0</p>
            </div>
            <div class="stat text-center">
                <h3>Fauna</h3>
                <p id="total-fauna" class="fs-4">0</p>
            </div>
            <div class="stat text-center">
                <h3>Flora</h3>
                <p id="total-flora" class="fs-4">0</p>
            </div>
        </div>

        <div id="map" style="height: 400px; margin-bottom: 20px;"></div>

        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Imagen</th>
                </tr>
            </thead>
            <tbody>
                {% for avistamiento in avistamientos %}
                <tr>
                    <td>{{ avistamiento.nombre }}</td>
                    <td>{{ avistamiento.descripcion }}</td>
                    <td>{{ avistamiento.tipo_especie }}</td>
                    <td>{{ avistamiento.estado_conservacion }}</td>
                    <td class="text-center">
                        <p>Debugging imagen_url: {{ avistamiento.imagen_url }}</p>
                        {% if avistamiento.imagen_url %}
                        <img src="{{ avistamiento.imagen_url }}" alt="Foto de {{ avistamiento.nombre }}" class="img-thumbnail" style="max-width: 150px;">
                        {% else %}
                        <span>No disponible</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const avistamientos = {{ avistamientos_json|safe }};
            const totalEspecies = avistamientos.length;
            const totalFauna = avistamientos.filter(a => a.tipo_especie === 'fauna').length;
            const totalFlora = avistamientos.filter(a => a.tipo_especie === 'flora').length;

            document.getElementById('total-especies').textContent = totalEspecies;
            document.getElementById('total-fauna').textContent = totalFauna;
            document.getElementById('total-flora').textContent = totalFlora;

            const map = L.map('map').setView([4.5709, -74.2973], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            avistamientos.forEach(function(avist) {
                if (avist.latitud !== null && avist.longitud !== null) {
                    const imagenUrl = avist.imagen_url;
                    L.marker([avist.latitud, avist.longitud]).addTo(map)
                        .bindPopup(`
                            <strong>${avist.nombre}</strong><br>
                            ${avist.descripcion}<br>
                            üìÖ Fecha: ${avist.fecha_creacion}<br>
                            üè∑Ô∏è Tipo: ${avist.tipo_especie}<br>
                            ‚ö†Ô∏è Estado de Conservaci√≥n: ${avist.estado_conservacion}<br>
                            <img src="${imagenUrl}" alt="Foto de ${avist.nombre}" width="100" style="border-radius: 5px;">
                        `);
                }
            });
        });
    </script>
    {% endblock %}
</body>
</html>
